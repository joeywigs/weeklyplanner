<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MealFlow - Weekly Meal Planner</title>
  <meta name="description" content="A smart weekly meal planning and shopping app for busy families">
  <meta name="theme-color" content="#16a34a">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      color: #1a1a1a;
    }

    /* ---- Pages ---- */
    .container { max-width: 480px; margin: 0 auto; padding: 24px 16px; }
    .page { display: none; }
    .page.active { display: block; }

    /* ---- Top Bar ---- */
    .top-bar {
      background: white; border-bottom: 1px solid #e5e7eb; padding: 12px 16px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 40;
    }
    .top-bar-title { font-size: 18px; font-weight: 700; color: #111; }
    .top-bar-week { font-size: 13px; color: #6b7280; }

    /* ---- Plan the Week Button ---- */
    .plan-btn {
      display: block; width: 100%; padding: 14px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      font-family: inherit;
    }
    .plan-btn.ready { background: #16a34a; color: white; }
    .plan-btn.ready:hover { background: #15803d; }
    .plan-btn.planning { background: #fef9c3; color: #a16207; cursor: wait; }
    .plan-btn.complete { background: #dcfce7; color: #15803d; cursor: default; }

    /* ---- Calendar Setup Banner ---- */
    .cal-setup {
      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px;
      padding: 16px; margin-bottom: 12px; margin-top: 4px;
    }
    .cal-setup-title { font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 8px; }
    .cal-setup-desc { font-size: 12px; color: #3b82f6; margin-bottom: 10px; line-height: 1.5; }
    .cal-input-row { display: flex; gap: 8px; }
    .cal-input {
      flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px;
      font-size: 13px; font-family: inherit; outline: none;
    }
    .cal-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.15); }
    .cal-save-btn {
      padding: 10px 16px; background: #2563eb; color: white; border: none;
      border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; white-space: nowrap;
    }
    .cal-save-btn:hover { background: #1d4ed8; }
    .cal-status {
      font-size: 12px; margin-top: 8px; padding: 6px 10px; border-radius: 6px;
    }
    .cal-status.success { background: #dcfce7; color: #15803d; }
    .cal-status.error { background: #fee2e2; color: #dc2626; }
    .cal-status.loading { background: #fef9c3; color: #a16207; }
    .cal-connected {
      background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px;
      padding: 12px 16px; margin-bottom: 12px; margin-top: 4px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .cal-connected-text { font-size: 13px; color: #15803d; font-weight: 500; }
    .cal-connected-count { font-size: 12px; color: #6b7280; }
    .cal-disconnect {
      background: none; border: none; color: #9ca3af; font-size: 12px;
      cursor: pointer; text-decoration: underline; font-family: inherit;
    }

    /* ---- Weekly Grid ---- */
    .week-table { margin-top: 16px; }
    .day-row {
      background: white; border-radius: 12px; margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06); overflow: hidden;
    }
    .day-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid #f3f4f6;
    }
    .day-label { font-weight: 700; font-size: 15px; color: #111; }
    .day-date { font-size: 12px; color: #9ca3af; }
    .day-columns { display: grid; grid-template-columns: 1fr 1fr; min-height: 72px; }
    .day-col { padding: 10px 16px; display: flex; flex-direction: column; justify-content: center; }
    .day-col:first-child { border-right: 1px solid #f3f4f6; }
    .event-item { margin-bottom: 6px; }
    .event-item:last-child { margin-bottom: 0; }
    .event-title { font-size: 13px; font-weight: 600; color: #374151; }
    .event-detail { font-size: 11px; color: #9ca3af; }
    .event-time { font-size: 11px; color: #6b7280; font-weight: 500; }
    .no-events { font-size: 13px; color: #d1d5db; font-style: italic; }
    .col-headers {
      display: grid; grid-template-columns: 1fr 1fr;
      padding: 8px 16px; margin-top: 12px;
    }
    .col-headers span {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: #6b7280;
    }
    .col-headers span:last-child { padding-left: 16px; }

    /* Dinner column */
    .dinner-name { font-size: 14px; font-weight: 600; color: #111; }
    .dinner-meta { display: flex; gap: 8px; margin-top: 4px; align-items: center; }
    .dinner-prep { font-size: 11px; color: #6b7280; }
    .effort-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .effort-dot.easy { background: #22c55e; }
    .effort-dot.medium { background: #eab308; }
    .effort-dot.hard { background: #ef4444; }
    .effort-label { font-size: 11px; color: #6b7280; }
    .dinner-empty { font-size: 13px; color: #d1d5db; font-style: italic; }
    .dinner-assigned { background: #f0fdf4; border-radius: 8px; padding: 8px; margin: -4px; }

    /* ---- Back button ---- */
    .back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: none; border: none; font-size: 14px; color: #16a34a;
      font-weight: 600; cursor: pointer; padding: 8px 0; margin-bottom: 16px;
    }
    .page-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #111; }

    /* ---- Recipe List ---- */
    .search-bar {
      background: white; border-radius: 12px; padding: 12px 16px;
      display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .search-bar input { border: none; outline: none; flex: 1; font-size: 15px; font-family: inherit; }
    .recipe-card {
      background: white; border-radius: 12px; padding: 16px; margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .recipe-name { font-weight: 600; font-size: 15px; }
    .recipe-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 12px; color: #9ca3af; }
    .effort-badge { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .effort-easy { background: #dcfce7; color: #15803d; }
    .effort-medium { background: #fef9c3; color: #a16207; }
    .effort-hard { background: #fee2e2; color: #dc2626; }

    /* ---- Shopping List ---- */
    .category-section { margin-bottom: 20px; }
    .category-title {
      font-size: 13px; font-weight: 600; text-transform: uppercase;
      color: #6b7280; letter-spacing: 0.5px; margin-bottom: 8px;
    }
    .shopping-item {
      background: white; border-radius: 10px; padding: 12px 16px; margin-bottom: 4px;
      display: flex; align-items: center; gap: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: opacity 0.15s;
    }
    .shopping-item.checked { opacity: 0.5; text-decoration: line-through; }
    .checkbox {
      width: 22px; height: 22px; border: 2px solid #d1d5db; border-radius: 6px;
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; font-size: 13px;
    }
    .shopping-item.checked .checkbox { background: #16a34a; border-color: #16a34a; color: white; }
    .item-name { font-size: 14px; }
    .item-qty { font-size: 12px; color: #9ca3af; margin-left: auto; }
    .progress-bar { background: #e5e7eb; border-radius: 999px; height: 8px; margin-bottom: 20px; overflow: hidden; }
    .progress-fill { background: #16a34a; height: 100%; border-radius: 999px; transition: width 0.3s; }

    /* ---- Settings ---- */
    .feature-card {
      background: white; border-radius: 16px; padding: 20px; display: flex;
      align-items: center; gap: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .feature-icon { font-size: 32px; flex-shrink: 0; width: 48px; text-align: center; }
    .feature-title { font-size: 16px; font-weight: 600; color: #111; }
    .feature-desc { font-size: 13px; color: #6b7280; margin-top: 2px; }

    .import-section {
      background: white; border-radius: 16px; padding: 20px; margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .import-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .import-section p { font-size: 13px; color: #6b7280; margin-bottom: 12px; }
    .import-dropzone {
      border: 2px dashed #d1d5db; border-radius: 12px; padding: 24px; text-align: center;
      cursor: pointer; transition: border-color 0.15s, background 0.15s;
    }
    .import-dropzone:hover, .import-dropzone.dragover {
      border-color: #16a34a; background: #f0fdf4;
    }
    .import-dropzone input[type="file"] { display: none; }
    .import-dropzone .drop-label { font-size: 14px; color: #6b7280; }
    .import-dropzone .drop-label strong { color: #16a34a; }
    .import-status {
      margin-top: 12px; padding: 10px 14px; border-radius: 10px; font-size: 13px; display: none;
    }
    .import-status.success { display: block; background: #dcfce7; color: #15803d; }
    .import-status.error { display: block; background: #fee2e2; color: #dc2626; }
    .import-status.loading { display: block; background: #f3f4f6; color: #6b7280; }
    .nut-warning {
      background: #fef3c7; color: #92400e; font-size: 12px; padding: 6px 10px;
      border-radius: 8px; margin-top: 4px;
    }

    /* ---- Bottom Nav ---- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; background: white;
      border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around;
      padding: 8px 0 env(safe-area-inset-bottom, 8px); z-index: 50;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 8px 16px; cursor: pointer; color: #9ca3af; background: none;
      border: none; font-family: inherit; transition: color 0.15s;
    }
    .nav-item.active { color: #16a34a; }
    .nav-item .nav-label { font-size: 11px; font-weight: 500; }
    .nav-item svg { width: 24px; height: 24px; }
  </style>
</head>
<body>

  <!-- ======== PLAN PAGE (Main App Home) ======== -->
  <div id="page-plan" class="page">
    <div class="top-bar">
      <div>
        <div class="top-bar-title">MealFlow</div>
        <div style="font-size:11px;color:#9ca3af;" id="build-stamp"></div>
        <div class="top-bar-week" id="week-range"></div>
      </div>
    </div>
    <div class="container" style="padding-bottom: 90px;">
      <!-- Calendar setup / status -->
      <div id="cal-setup-area"></div>

      <!-- Plan the Week button -->
      <div style="margin-bottom: 8px;">
        <button class="plan-btn ready" id="plan-btn" onclick="planTheWeek()">
          Plan the Week
        </button>
      </div>

      <div class="col-headers">
        <span>Calendar</span>
        <span>Dinner</span>
      </div>

      <div id="week-table" class="week-table"></div>
    </div>
  </div>

  <!-- ======== RECIPES PAGE ======== -->
  <div id="page-recipes" class="page">
    <div class="container" style="padding-bottom: 80px;">
      <div class="page-title">Recipes</div>
      <div class="search-bar">
        <span>üîç</span>
        <input type="text" placeholder="Search recipes..." oninput="filterRecipes(this.value)">
      </div>
      <div id="recipe-list"></div>
    </div>
  </div>

  <!-- ======== SHOPPING PAGE ======== -->
  <div id="page-shopping" class="page">
    <div class="container" style="padding-bottom: 80px;">
      <div class="page-title">Shopping List</div>
      <div class="progress-bar">
        <div class="progress-fill" id="shopping-progress" style="width: 0%"></div>
      </div>
      <div id="shopping-list"></div>
    </div>
  </div>

  <!-- ======== SETTINGS PAGE ======== -->
  <div id="page-settings" class="page">
    <div class="container" style="padding-bottom: 80px;">
      <div class="page-title">Settings</div>

      <!-- Paprika import -->
      <div class="import-section">
        <h3>Import Paprika Recipes</h3>
        <p>Export from Paprika 3 and upload your <strong>.paprikarecipes</strong> file here.</p>
        <div class="import-dropzone" id="import-dropzone" onclick="document.getElementById('paprika-file').click()">
          <input type="file" id="paprika-file" accept=".paprikarecipes" onchange="handlePaprikaFile(this.files)">
          <div class="drop-label"><strong>Choose file</strong> or drag & drop</div>
        </div>
        <div class="import-status" id="import-status"></div>
      </div>

      <!-- Calendar URL setting -->
      <div class="feature-card" style="margin-bottom: 12px; cursor: pointer;" onclick="showPage('plan')">
        <div class="feature-icon">üìÖ</div>
        <div>
          <div class="feature-title">Calendar</div>
          <div class="feature-desc" id="settings-cal-status">Not connected</div>
        </div>
      </div>
      <div class="feature-card" style="margin-bottom: 12px;">
        <div class="feature-icon">üè™</div>
        <div>
          <div class="feature-title">Pantry Staples</div>
          <div class="feature-desc">Salt, pepper, olive oil, butter, garlic, and 15 more</div>
        </div>
      </div>
      <div class="feature-card" style="margin-bottom: 12px;">
        <div class="feature-icon">üîÑ</div>
        <div>
          <div class="feature-title">Recurring Essentials</div>
          <div class="feature-desc">Items you buy every week regardless of meal plan</div>
        </div>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ü•ú</div>
        <div>
          <div class="feature-title">Tree Nut Safety</div>
          <div class="feature-desc">Enabled ‚Äî all recipes scanned automatically</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== BOTTOM NAV ======== -->
  <div class="bottom-nav" id="bottom-nav" style="display: none;">
    <button class="nav-item" onclick="showPage('plan')" data-page="plan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span class="nav-label">Plan</span>
    </button>
    <button class="nav-item" onclick="showPage('recipes')" data-page="recipes">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
      <span class="nav-label">Recipes</span>
    </button>
    <button class="nav-item" onclick="showPage('shopping')" data-page="shopping">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
      <span class="nav-label">Shopping</span>
    </button>
    <button class="nav-item" onclick="showPage('settings')" data-page="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span class="nav-label">Settings</span>
    </button>
  </div>

  <script>
    // ---- Constants ----
    var CORS_PROXIES = [
      { prefix: 'https://api.allorigins.win/raw?url=', encode: true },
      { prefix: 'https://corsproxy.io/?', encode: true }
    ];
    var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    var today = new Date();
    var monday = new Date(today);
    monday.setDate(today.getDate() - ((today.getDay() + 6) % 7));
    monday.setHours(0, 0, 0, 0);

    // ---- State ----
    // calendarEvents[0..6] = arrays of {title, where, duration, startTime, endTime}
    var calendarEvents = [[], [], [], [], [], [], []];
    var calendarConnected = false;
    var calendarEventCount = 0;

    var DEFAULT_RECIPES = [
      { name: 'Chicken Stir Fry', effort: 'easy', time: '25 min', servings: 4 },
      { name: 'Pasta Carbonara', effort: 'easy', time: '20 min', servings: 2 },
      { name: 'Beef Tacos', effort: 'easy', time: '30 min', servings: 4 },
      { name: 'Salmon with Roasted Vegetables', effort: 'medium', time: '45 min', servings: 2 },
      { name: 'Homemade Pizza', effort: 'medium', time: '60 min', servings: 4 },
      { name: 'Thai Green Curry', effort: 'medium', time: '35 min', servings: 4 },
      { name: 'Beef Bourguignon', effort: 'hard', time: '180 min', servings: 6 },
      { name: 'Grilled Cheese and Tomato Soup', effort: 'easy', time: '15 min', servings: 2 },
      { name: 'Chicken Parmesan', effort: 'medium', time: '50 min', servings: 4 },
      { name: 'Shrimp Scampi', effort: 'easy', time: '20 min', servings: 2 },
    ];
    var recipes = loadRecipes();
    var dinners = [null, null, null, null, null, null, null];
    var easyMeals, mediumMeals;
    rebuildEffortPools();

    function rebuildEffortPools() {
      easyMeals = recipes.filter(function(r) { return r.effort === 'easy'; });
      mediumMeals = recipes.filter(function(r) { return r.effort === 'medium'; });
    }

    function loadRecipes() {
      try {
        var saved = localStorage.getItem('mealflow_recipes');
        if (saved) return JSON.parse(saved);
      } catch (e) { /* ignore */ }
      return DEFAULT_RECIPES.slice();
    }

    function saveRecipes() {
      localStorage.setItem('mealflow_recipes', JSON.stringify(recipes));
    }
    var planState = 'ready';

    var shoppingItems = {
      'Produce': [
        { name: 'Bell peppers', qty: '3', checked: false },
        { name: 'Broccoli', qty: '2 heads', checked: false },
        { name: 'Onions', qty: '4', checked: false },
        { name: 'Garlic', qty: '1 head', checked: true },
        { name: 'Limes', qty: '3', checked: false },
        { name: 'Cilantro', qty: '1 bunch', checked: false },
      ],
      'Meat and Seafood': [
        { name: 'Chicken breast', qty: '2 lbs', checked: false },
        { name: 'Ground beef', qty: '1.5 lbs', checked: false },
        { name: 'Bacon', qty: '8 oz', checked: true },
      ],
      'Dairy': [
        { name: 'Parmesan cheese', qty: '4 oz', checked: false },
        { name: 'Sour cream', qty: '8 oz', checked: false },
        { name: 'Eggs', qty: '1 dozen', checked: true },
      ],
      'Pantry': [
        { name: 'Soy sauce', qty: '1 bottle', checked: false },
        { name: 'Spaghetti', qty: '1 lb', checked: false },
        { name: 'Taco shells', qty: '12 ct', checked: false },
        { name: 'Tortillas', qty: '10 ct', checked: true },
      ],
    };

    // ========================================
    // ICS PARSER
    // ========================================
    function parseICS(icsText) {
      var events = [];
      var lines = icsText.replace(/\r\n /g, '').replace(/\r\n\t/g, '').split(/\r\n|\n|\r/);
      var inEvent = false;
      var evt = {};

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line === 'BEGIN:VEVENT') {
          inEvent = true;
          evt = {};
        } else if (line === 'END:VEVENT') {
          inEvent = false;
          if (evt.dtstart) {
            events.push(evt);
          }
        } else if (inEvent) {
          var colonIdx = line.indexOf(':');
          if (colonIdx < 0) continue;
          var key = line.substring(0, colonIdx);
          var val = line.substring(colonIdx + 1);

          // Strip parameters (e.g. DTSTART;TZID=America/New_York)
          var baseKey = key.split(';')[0];

          if (baseKey === 'SUMMARY') {
            evt.summary = unescapeICS(val);
          } else if (baseKey === 'LOCATION') {
            evt.location = unescapeICS(val);
          } else if (baseKey === 'DTSTART') {
            evt.dtstart = parseICSDate(val, key);
          } else if (baseKey === 'DTEND') {
            evt.dtend = parseICSDate(val, key);
          } else if (baseKey === 'DURATION') {
            evt.duration = val;
          }
        }
      }
      return events;
    }

    function unescapeICS(s) {
      return s.replace(/\\n/g, ' ').replace(/\\,/g, ',').replace(/\\\\/g, '\\').replace(/\\;/g, ';');
    }

    function parseICSDate(val, fullKey) {
      // Handle TZID parameter
      var tzid = null;
      var parts = fullKey.split(';');
      for (var i = 1; i < parts.length; i++) {
        if (parts[i].indexOf('TZID=') === 0) {
          tzid = parts[i].substring(5);
        }
      }

      // All-day event: 20260207
      if (val.length === 8) {
        var y = parseInt(val.substring(0, 4));
        var m = parseInt(val.substring(4, 6)) - 1;
        var d = parseInt(val.substring(6, 8));
        return { date: new Date(y, m, d), allDay: true };
      }

      // Date with time: 20260207T180000Z or 20260207T180000
      var dateStr = val.replace('Z', '');
      var yr = parseInt(dateStr.substring(0, 4));
      var mo = parseInt(dateStr.substring(4, 6)) - 1;
      var dy = parseInt(dateStr.substring(6, 8));
      var hr = parseInt(dateStr.substring(9, 11));
      var mi = parseInt(dateStr.substring(11, 13));
      var sc = parseInt(dateStr.substring(13, 15)) || 0;

      var dt;
      if (val.indexOf('Z') >= 0) {
        dt = new Date(Date.UTC(yr, mo, dy, hr, mi, sc));
      } else {
        // Local time (with or without TZID ‚Äî treat as local for simplicity)
        dt = new Date(yr, mo, dy, hr, mi, sc);
      }
      return { date: dt, allDay: false };
    }

    function formatTime(d) {
      var h = d.getHours();
      var m = d.getMinutes();
      var ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return h + (m > 0 ? ':' + (m < 10 ? '0' : '') + m : '') + ampm;
    }

    function durationMinutes(start, end) {
      if (!start || !end) return '';
      var mins = Math.round((end.date - start.date) / 60000);
      if (mins < 60) return mins + ' min';
      var hrs = Math.floor(mins / 60);
      var rem = mins % 60;
      return hrs + (rem > 0 ? '.' + Math.round(rem / 6) : '') + ' hr';
    }

    // ========================================
    // FETCH & PROCESS CALENDAR
    // ========================================
    function fetchCalendar(url, callback) {
      // Normalize URL: decode first to prevent double-encoding (%40 -> %2540)
      try { url = decodeURIComponent(url); } catch (e) { /* already decoded */ }

      function tryProxy(index) {
        if (index >= CORS_PROXIES.length) {
          callback('All calendar proxies failed. The iCal URL may be invalid or expired ‚Äî try generating a new one from Google Calendar settings.');
          return;
        }
        var proxy = CORS_PROXIES[index];
        var proxyUrl = proxy.prefix + (proxy.encode ? encodeURIComponent(url) : url);
        var xhr = new XMLHttpRequest();
        xhr.open('GET', proxyUrl, true);
        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            callback(null, xhr.responseText);
          } else {
            tryProxy(index + 1);
          }
        };
        xhr.onerror = function() {
          tryProxy(index + 1);
        };
        xhr.send();
      }
      tryProxy(0);
    }

    function processCalendarData(icsText) {
      var allEvents = parseICS(icsText);
      var sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 7);

      // Reset
      calendarEvents = [[], [], [], [], [], [], []];
      calendarEventCount = 0;

      for (var i = 0; i < allEvents.length; i++) {
        var evt = allEvents[i];
        if (!evt.dtstart) continue;
        var start = evt.dtstart.date;
        var end = evt.dtend ? evt.dtend.date : null;

        // Check if event falls within this week
        if (start >= sunday) continue;
        if (end && end <= monday) continue;
        if (!end && start < monday) continue;

        // Determine which day(s) this event falls on
        for (var d = 0; d < 7; d++) {
          var dayStart = new Date(monday);
          dayStart.setDate(monday.getDate() + d);
          dayStart.setHours(0, 0, 0, 0);
          var dayEnd = new Date(dayStart);
          dayEnd.setDate(dayEnd.getDate() + 1);

          // Event overlaps this day?
          var eventStart = start;
          var eventEnd = end || new Date(start.getTime() + 3600000);
          if (eventStart < dayEnd && eventEnd > dayStart) {
            var timeStr = '';
            if (!evt.dtstart.allDay) {
              timeStr = formatTime(start);
              if (end) timeStr += ' - ' + formatTime(end);
            }
            calendarEvents[d].push({
              title: evt.summary || 'Untitled',
              where: evt.location || '',
              duration: durationMinutes(evt.dtstart, evt.dtend),
              timeStr: timeStr,
              allDay: evt.dtstart.allDay
            });
            calendarEventCount++;
          }
        }
      }

      // Sort each day by time
      for (var d = 0; d < 7; d++) {
        calendarEvents[d].sort(function(a, b) {
          if (a.allDay && !b.allDay) return -1;
          if (!a.allDay && b.allDay) return 1;
          return 0;
        });
      }
    }

    // ========================================
    // CALENDAR SETUP UI
    // ========================================
    function renderCalSetup() {
      var area = document.getElementById('cal-setup-area');
      var savedUrl = localStorage.getItem('mealflow_ical_url');

      if (calendarConnected) {
        area.innerHTML =
          '<div class="cal-connected">' +
            '<div>' +
              '<div class="cal-connected-text">Calendar connected</div>' +
              '<div class="cal-connected-count">' + calendarEventCount + ' events this week</div>' +
            '</div>' +
            '<button class="cal-disconnect" onclick="disconnectCalendar()">Disconnect</button>' +
          '</div>';
        document.getElementById('settings-cal-status').textContent =
          'Connected ‚Äî ' + calendarEventCount + ' events this week';
        return;
      }

      area.innerHTML =
        '<div class="cal-setup">' +
          '<div class="cal-setup-title">Connect Your Calendar</div>' +
          '<div class="cal-setup-desc">' +
            'Paste your Google Calendar secret iCal URL below.<br>' +
            'Find it in Google Calendar Settings > your calendar > "Secret address in iCal format"' +
          '</div>' +
          '<div class="cal-input-row">' +
            '<input class="cal-input" id="ical-url-input" type="text" ' +
              'placeholder="https://calendar.google.com/calendar/ical/..." ' +
              'value="' + (savedUrl || '') + '">' +
            '<button class="cal-save-btn" onclick="connectCalendar()">Connect</button>' +
          '</div>' +
          '<div id="cal-status"></div>' +
        '</div>';
      document.getElementById('settings-cal-status').textContent = 'Not connected';
    }

    function connectCalendar() {
      var input = document.getElementById('ical-url-input');
      var url = input.value.trim();
      if (!url) return;

      // Basic validation
      if (url.indexOf('calendar.google.com') < 0 && url.indexOf('.ics') < 0) {
        showCalStatus('That doesn\'t look like an iCal URL. It should end in .ics', 'error');
        return;
      }

      showCalStatus('Fetching calendar...', 'loading');

      fetchCalendar(url, function(err, data) {
        if (err) {
          showCalStatus(err, 'error');
          return;
        }
        if (data.indexOf('BEGIN:VCALENDAR') < 0) {
          showCalStatus('Invalid calendar data received. Check the URL.', 'error');
          return;
        }

        // Save URL and process
        localStorage.setItem('mealflow_ical_url', url);
        processCalendarData(data);
        calendarConnected = true;

        renderCalSetup();
        renderWeek();
      });
    }

    function disconnectCalendar() {
      localStorage.removeItem('mealflow_ical_url');
      calendarConnected = false;
      calendarEvents = [[], [], [], [], [], [], []];
      calendarEventCount = 0;
      // Reset plan state so user can re-plan
      planState = 'ready';
      dinners = [null, null, null, null, null, null, null];
      var btn = document.getElementById('plan-btn');
      btn.className = 'plan-btn ready';
      btn.textContent = 'Plan the Week';

      renderCalSetup();
      renderWeek();
    }

    function showCalStatus(msg, type) {
      var el = document.getElementById('cal-status');
      if (el) {
        el.innerHTML = '<div class="cal-status ' + type + '">' + msg + '</div>';
      }
    }

    // ========================================
    // PLAN THE WEEK
    // ========================================
    function planTheWeek() {
      if (planState !== 'ready') return;

      var btn = document.getElementById('plan-btn');
      planState = 'planning';
      btn.className = 'plan-btn planning';
      btn.textContent = 'Planning...';

      setTimeout(function() {
        for (var i = 0; i < 7; i++) {
          var eventCount = calendarEvents[i].length;
          var pool;
          if (eventCount >= 3) {
            pool = easyMeals;
          } else if (eventCount >= 1) {
            pool = easyMeals.concat(mediumMeals);
          } else {
            pool = recipes;
          }
          var pick;
          var attempts = 0;
          do {
            pick = pool[Math.floor(Math.random() * pool.length)];
            attempts++;
          } while (dinners.indexOf(pick) >= 0 && attempts < 20);
          dinners[i] = pick;
        }

        planState = 'complete';
        btn.className = 'plan-btn complete';
        btn.textContent = 'Planning Complete';
        renderWeek();
      }, 1200);
    }

    // ========================================
    // RENDER WEEK
    // ========================================
    function renderWeek() {
      var sun = new Date(monday);
      sun.setDate(monday.getDate() + 6);
      document.getElementById('week-range').textContent =
        monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' +
        sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      var table = document.getElementById('week-table');
      table.innerHTML = days.map(function(day, i) {
        var date = new Date(monday);
        date.setDate(monday.getDate() + i);
        var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        var events = calendarEvents[i];
        var dinner = dinners[i];

        // Calendar events column
        var eventsHtml;
        if (events.length === 0) {
          eventsHtml = '<div class="no-events">No events</div>';
        } else {
          eventsHtml = events.map(function(e) {
            var detail = '';
            if (e.allDay) {
              detail = 'All day';
            } else if (e.timeStr) {
              detail = e.timeStr;
            }
            if (e.where) {
              detail += (detail ? ' ¬∑ ' : '') + e.where;
            }
            if (e.duration && !e.allDay) {
              detail += (detail ? ' ¬∑ ' : '') + e.duration;
            }
            return '<div class="event-item">' +
              '<div class="event-title">' + escapeHtml(e.title) + '</div>' +
              (detail ? '<div class="event-detail">' + escapeHtml(detail) + '</div>' : '') +
            '</div>';
          }).join('');
        }

        // Dinner column
        var dinnerHtml;
        if (dinner) {
          dinnerHtml =
            '<div class="dinner-assigned">' +
              '<div class="dinner-name">' + dinner.name + '</div>' +
              '<div class="dinner-meta">' +
                '<span class="dinner-prep">' + dinner.time + '</span>' +
                '<span class="effort-dot ' + dinner.effort + '"></span>' +
                '<span class="effort-label">' + dinner.effort + '</span>' +
              '</div>' +
            '</div>';
        } else {
          dinnerHtml = '<div class="dinner-empty">Not planned</div>';
        }

        return '<div class="day-row">' +
          '<div class="day-header">' +
            '<span class="day-label">' + day + '</span>' +
            '<span class="day-date">' + dateStr + '</span>' +
          '</div>' +
          '<div class="day-columns">' +
            '<div class="day-col">' + eventsHtml + '</div>' +
            '<div class="day-col">' + dinnerHtml + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function escapeHtml(s) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(s));
      return div.innerHTML;
    }

    // ========================================
    // PAPRIKA IMPORT
    // ========================================

    var TREE_NUT_KEYWORDS = [
      'almond', 'walnut', 'pecan', 'cashew', 'pistachio', 'macadamia',
      'brazil nut', 'hazelnut', 'filbert', 'pine nut', 'praline', 'marzipan',
      'nougat', 'gianduja', 'almond flour', 'almond milk', 'almond butter',
      'almond extract', 'walnut oil', 'pecan pie', 'cashew cream',
      'cashew butter', 'pistachio cream', 'hazelnut spread', 'pine nuts',
      'marcona', 'frangipane', 'amaretti', 'nutella'
    ];

    function scanForTreeNuts(text) {
      var lower = text.toLowerCase();
      var matched = [];
      for (var i = 0; i < TREE_NUT_KEYWORDS.length; i++) {
        if (lower.indexOf(TREE_NUT_KEYWORDS[i]) >= 0) matched.push(TREE_NUT_KEYWORDS[i]);
      }
      return matched;
    }

    function parseTimeToMinutes(str) {
      if (!str || !str.trim()) return null;
      var lower = str.toLowerCase().trim();
      var total = 0; var found = false;
      var hm = lower.match(/(\d+)\s*(?:h(?:ours?)?)/);
      if (hm) { total += parseInt(hm[1], 10) * 60; found = true; }
      var mm = lower.match(/(\d+)\s*(?:m(?:in(?:utes?)?)?)/);
      if (mm) { total += parseInt(mm[1], 10); found = true; }
      if (found) return total;
      var n = parseInt(lower, 10);
      return isNaN(n) ? null : n;
    }

    function mapDifficulty(d) {
      var lower = (d || '').toLowerCase();
      if (lower.indexOf('easy') >= 0 || lower.indexOf('simple') >= 0 || lower.indexOf('quick') >= 0) return 'easy';
      if (lower.indexOf('hard') >= 0 || lower.indexOf('difficult') >= 0 || lower.indexOf('complex') >= 0) return 'hard';
      return 'medium';
    }

    function formatMinutes(min) {
      if (!min) return '? min';
      if (min >= 60) return Math.floor(min / 60) + ' hr ' + (min % 60 > 0 ? min % 60 + ' min' : '');
      return min + ' min';
    }

    async function decompressGzip(buffer) {
      return decompressStream(buffer, 'gzip');
    }

    async function decompressStream(buffer, format) {
      var ds = new DecompressionStream(format);
      var writer = ds.writable.getWriter();
      writer.write(buffer);
      writer.close();
      var reader = ds.readable.getReader();
      var chunks = [];
      while (true) {
        var result = await reader.read();
        if (result.done) break;
        chunks.push(result.value);
      }
      var totalLen = 0;
      for (var i = 0; i < chunks.length; i++) totalLen += chunks[i].length;
      var out = new Uint8Array(totalLen);
      var offset = 0;
      for (var j = 0; j < chunks.length; j++) {
        out.set(chunks[j], offset);
        offset += chunks[j].length;
      }
      return out.buffer;
    }

    async function extractPaprikaArchive(buffer) {
      var bytes = new Uint8Array(buffer);
      var results = [];

      // Check for ZIP magic number (PK\x03\x04)
      if (bytes[0] === 0x50 && bytes[1] === 0x4b) {
        var pos = 0;
        while (pos < bytes.length - 30) {
          if (bytes[pos] !== 0x50 || bytes[pos+1] !== 0x4b || bytes[pos+2] !== 0x03 || bytes[pos+3] !== 0x04) break;
          var view = new DataView(buffer, pos);
          var compressionMethod = view.getUint16(8, true); // 0=stored, 8=deflate
          var compSize = view.getUint32(18, true);
          var nameLen = view.getUint16(26, true);
          var extraLen = view.getUint16(28, true);
          var nameBytes = bytes.slice(pos + 30, pos + 30 + nameLen);
          var fileName = new TextDecoder().decode(nameBytes);
          var dataStart = pos + 30 + nameLen + extraLen;
          var fileData = buffer.slice(dataStart, dataStart + compSize);

          if (fileName.indexOf('.paprikarecipe') >= 0) {
            try {
              // Step 1: undo ZIP compression (deflate-raw or stored)
              var innerData;
              if (compressionMethod === 8) {
                innerData = await decompressStream(fileData, 'deflate-raw');
              } else {
                innerData = fileData; // stored (method 0)
              }

              // Step 2: each .paprikarecipe is gzip-compressed JSON ‚Äî try to decompress
              var jsonStr;
              try {
                var decompressed = await decompressGzip(innerData);
                jsonStr = new TextDecoder().decode(decompressed);
              } catch (gzErr) {
                // Not gzip ‚Äî might be plain JSON already
                jsonStr = new TextDecoder().decode(innerData);
              }

              results.push(JSON.parse(jsonStr));
            } catch (e) {
              console.error('Failed to parse recipe: ' + fileName, e);
            }
          }
          pos = dataStart + compSize;
        }
      } else {
        // Try as single gzip JSON
        try {
          var dec = await decompressGzip(buffer);
          var parsed = JSON.parse(new TextDecoder().decode(dec));
          if (Array.isArray(parsed)) results = parsed;
          else results.push(parsed);
        } catch (e) {
          throw new Error('Unable to parse .paprikarecipes file');
        }
      }
      return results;
    }

    function showImportStatus(msg, type) {
      var el = document.getElementById('import-status');
      el.className = 'import-status ' + type;
      el.innerHTML = msg;
    }

    async function handlePaprikaFile(files) {
      if (!files || !files.length) return;
      var file = files[0];
      if (file.name.indexOf('.paprikarecipes') < 0) {
        showImportStatus('Please select a .paprikarecipes file.', 'error');
        return;
      }

      showImportStatus('Reading file...', 'loading');

      try {
        var buffer = await file.arrayBuffer();
        showImportStatus('Extracting recipes...', 'loading');
        var paprikaRecipes = await extractPaprikaArchive(buffer);

        if (paprikaRecipes.length === 0) {
          showImportStatus('No recipes found in this file.', 'error');
          return;
        }

        var imported = 0;
        var skippedNuts = 0;
        var nutWarnings = [];
        // Track existing recipe names to avoid duplicates
        var existingNames = {};
        for (var e = 0; e < recipes.length; e++) existingNames[recipes[e].name.toLowerCase()] = true;

        for (var i = 0; i < paprikaRecipes.length; i++) {
          var pr = paprikaRecipes[i];
          var name = pr.name || 'Untitled Recipe';

          // Tree nut check across title, ingredients, directions, notes
          var allText = [name, pr.ingredients || '', pr.directions || '', pr.notes || ''].join(' ');
          var nutMatches = scanForTreeNuts(allText);
          if (nutMatches.length > 0) {
            skippedNuts++;
            nutWarnings.push(name + ' (' + nutMatches[0] + ')');
            continue;
          }

          // Skip duplicates
          if (existingNames[name.toLowerCase()]) continue;

          var totalMin = parseTimeToMinutes(pr.total_time) || parseTimeToMinutes(pr.cook_time) || parseTimeToMinutes(pr.prep_time);
          var servings = 4;
          if (pr.servings) {
            var sm = pr.servings.match(/(\d+)/);
            if (sm) servings = parseInt(sm[1], 10);
          }

          recipes.push({
            name: name,
            effort: mapDifficulty(pr.difficulty),
            time: formatMinutes(totalMin),
            servings: servings,
            ingredients: pr.ingredients || '',
            directions: pr.directions || '',
            source: pr.source_url || pr.source || ''
          });
          existingNames[name.toLowerCase()] = true;
          imported++;
        }

        saveRecipes();
        rebuildEffortPools();
        renderRecipes();

        var msg = 'Imported ' + imported + ' recipe' + (imported !== 1 ? 's' : '') + ' from ' + paprikaRecipes.length + ' total.';
        if (skippedNuts > 0) {
          msg += '<div class="nut-warning" style="margin-top:8px;">ü•ú Skipped ' + skippedNuts +
            ' recipe' + (skippedNuts !== 1 ? 's' : '') + ' containing tree nuts:<br>' +
            nutWarnings.map(function(w) { return '&bull; ' + escapeHtml(w); }).join('<br>') + '</div>';
        }
        showImportStatus(msg, 'success');

        // Reset the file input
        document.getElementById('paprika-file').value = '';
      } catch (err) {
        console.error('Paprika import error:', err);
        showImportStatus('Failed to import: ' + err.message, 'error');
      }
    }

    function initDragDrop() {
      var zone = document.getElementById('import-dropzone');
      if (!zone) return;
      zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
      zone.addEventListener('drop', function(e) {
        e.preventDefault();
        zone.classList.remove('dragover');
        handlePaprikaFile(e.dataTransfer.files);
      });
    }

    // ========================================
    // RENDER RECIPES
    // ========================================
    function renderRecipes(filter) {
      var list = document.getElementById('recipe-list');
      var filtered = filter
        ? recipes.filter(function(r) { return r.name.toLowerCase().indexOf(filter.toLowerCase()) >= 0; })
        : recipes;
      var countHtml = '<div style="font-size:13px;color:#6b7280;margin-bottom:12px;">' +
        filtered.length + ' recipe' + (filtered.length !== 1 ? 's' : '') +
        (filter ? ' matching "' + escapeHtml(filter) + '"' : '') + '</div>';
      list.innerHTML = countHtml + filtered.map(function(r) {
        return '<div class="recipe-card">' +
          '<div class="recipe-name">' + escapeHtml(r.name) + '</div>' +
          '<div class="recipe-meta">' +
            '<span class="effort-badge effort-' + r.effort + '">' + r.effort + '</span>' +
            '<span>‚è± ' + r.time + '</span>' +
            '<span>üçΩ ' + r.servings + ' servings</span>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // ========================================
    // RENDER SHOPPING
    // ========================================
    function renderShopping() {
      var list = document.getElementById('shopping-list');
      var html = '';
      var categories = Object.keys(shoppingItems);
      for (var c = 0; c < categories.length; c++) {
        var category = categories[c];
        var items = shoppingItems[category];
        html += '<div class="category-section"><div class="category-title">' + category + '</div>';
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          html += '<div class="shopping-item ' + (item.checked ? 'checked' : '') + '" ' +
            'onclick="toggleItem(\'' + category.replace(/'/g, "\\'") + '\', ' + i + ')">' +
            '<div class="checkbox">' + (item.checked ? '‚úì' : '') + '</div>' +
            '<span class="item-name">' + item.name + '</span>' +
            '<span class="item-qty">' + item.qty + '</span>' +
          '</div>';
        }
        html += '</div>';
      }
      list.innerHTML = html;
      updateProgress();
    }

    function toggleItem(category, index) {
      shoppingItems[category][index].checked = !shoppingItems[category][index].checked;
      renderShopping();
    }

    function updateProgress() {
      var all = [];
      var categories = Object.keys(shoppingItems);
      for (var c = 0; c < categories.length; c++) {
        var items = shoppingItems[categories[c]];
        for (var i = 0; i < items.length; i++) { all.push(items[i]); }
      }
      var checked = all.filter(function(i) { return i.checked; }).length;
      var pct = Math.round((checked / all.length) * 100);
      document.getElementById('shopping-progress').style.width = pct + '%';
    }

    function filterRecipes(val) { renderRecipes(val); }

    // ========================================
    // NAVIGATION
    // ========================================
    function showPage(page) {
      var pages = document.querySelectorAll('.page');
      for (var i = 0; i < pages.length; i++) { pages[i].classList.remove('active'); }
      document.getElementById('page-' + page).classList.add('active');

      var nav = document.getElementById('bottom-nav');
      nav.style.display = 'flex';

      var items = document.querySelectorAll('.nav-item');
      for (var j = 0; j < items.length; j++) {
        if (items[j].dataset.page === page) {
          items[j].classList.add('active');
        } else {
          items[j].classList.remove('active');
        }
      }

      if (page === 'plan') { renderCalSetup(); renderWeek(); }
      if (page === 'recipes') renderRecipes();
      if (page === 'shopping') renderShopping();

      window.scrollTo(0, 0);
    }

    // ========================================
    // INIT
    // ========================================
    var BUILD_TIMESTAMP = '2026-02-08 03:57 PM CST';

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('build-stamp').textContent = 'Updated ' + BUILD_TIMESTAMP;
      showPage('plan');
      initDragDrop();

      // Auto-load saved calendar
      var savedUrl = localStorage.getItem('mealflow_ical_url');
      if (savedUrl) {
        fetchCalendar(savedUrl, function(err, data) {
          if (!err && data.indexOf('BEGIN:VCALENDAR') >= 0) {
            processCalendarData(data);
            calendarConnected = true;
            renderCalSetup();
            renderWeek();
          }
        });
      }
    });
  </script>
</body>
</html>
